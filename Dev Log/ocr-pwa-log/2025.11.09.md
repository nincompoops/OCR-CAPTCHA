# 2025.11.09 (일) - OCR 기능 개선 및 모듈 충돌 해결

## 프로젝트 개요 및 목표 업데이트

* **핵심 목표:** Tesseract.js에 **한국어 인식** 기능을 추가하고, **Jimp 라이브러리**를 활용하여 클라이언트 측 이미지 전처리 로직을 구현함으로써 캡차 인식 정확도를 극대화.
* **당면 과제:** SvelteKit/Vite 환경에서 Node.js 기반 모듈인 Jimp 사용 시 발생하는 호환성 문제를 해결하고 전처리 기능을 안정화해야 함.

---

## 디버깅 과정 및 해결 (Troubleshooting Log)

OCR 정확도 개선을 위한 Jimp 통합 과정에서 발생한 모듈 충돌 문제를 다음과 같이 해결함.

### 1. Jimp 라이브러리 통합 중 TypeScript 타입 오류 해결

* **오류 내용:** `runOcr()` 함수 내에서 이미지의 `ArrayBuffer`를 Jimp로 읽으려 할 때, `Jimp.read(buffer as ArrayBuffer);` 구문에서 TypeScript 타입 검사 오류가 발생함.
    * `No overload matches this call. Argument of type 'ArrayBuffer' is not assignable to parameter of type 'string'.`
* **원인:** Jimp의 Node.js 환경 타입 정의는 파일 경로(`string`)나 Node.js `Buffer` 객체를 기대했기 때문에, 브라우저의 기본 `ArrayBuffer` 타입을 직접 인수로 사용하는 것이 타입 정의와 일치하지 않았음.
* **조치:**
    1.  `Buffer` 모듈을 명시적으로 가져옴 (`import { Buffer } from 'buffer';`).
    2.  `ArrayBuffer`를 Node.js 호환 `Buffer` 객체로 변환하여 `Jimp.read()`에 전달하도록 코드를 수정함: `const jimpImage = await Jimp.read(Buffer.from(buffer));`.
    3.  이 조치로 TypeScript 타입 오류는 해결됨.

### 2. Jimp 라이브러리 런타임 충돌로 인한 500 Internal Error 해결

* **오류 내용:** 타입 오류 해결 후 빌드 및 `npm run preview` 실행 시, **500 Internal Error**가 발생하며 서버 로그에 `TypeError: e.inherits is not a function` 메시지가 출력됨.
* **원인:** Jimp가 내부적으로 사용하는 이미지 처리 종속성(예: `pngjs`)이 Node.js의 내장 모듈 함수(`util.inherits` 등)에 의존하고 있었음. SvelteKit/Vite 환경은 브라우저 실행을 위해 코드를 번들링하며 이러한 Node.js 전용 모듈을 올바르게 에뮬레이션하지 못해 런타임에 충돌이 발생함.
* **조치:**
    1.  `jimp` 라이브러리가 브라우저 환경에서 사용하기에 부적합하다고 판단, **모든 Jimp 관련 의존성 및 코드를 롤백 및 제거함**.
    2.  대안으로 **브라우저 네이티브 Canvas API**를 사용하여 이미지 전처리 로직을 재구현함.
    3.  새로운 함수 `processImageWithCanvas(file)`를 구현하여, `HTMLCanvasElement`와 `ImageData`의 픽셀 조작을 통해 **그레이스케일 변환**을 안전하게 수행하도록 조치함.
    4.  전처리된 이미지를 `canvas.toBlob()`을 통해 `Blob` 형태로 Tesseract.js 워커에 전달하도록 통합함.

### 3. 한국어 OCR 및 PWA 캐싱 최종 확인

* **조치 내용:** 이미지 전처리 충돌 이슈와 별개로 구현했던 **Tesseract 한국어 지원** 설정(`'eng+kor'`)과 **PWA 캐싱 설정**(`traineddata.gz` 포함)은 유지함.
* **최종 상태:** Jimp 관련 모듈 충돌이 해결되고, Canvas API를 통한 그레이스케일 전처리가 적용된 상태에서 영어 및 한국어 OCR 기능이 정상적으로 작동하는 것을 확인하여 목표를 달성함.