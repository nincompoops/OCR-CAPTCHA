# 1ë‹¨ê³„: Next.js ë¹Œë“œ í™˜ê²½ (Builder Stage)
# í”Œë«í¼ ì§€ì •ì€ buildx ëª…ë ¹ì–´ì— ë§¡ê¸°ê³ , Dockerfileì€ ê¹¨ë—í•˜ê²Œ ìœ ì§€
FROM node:20-alpine AS builder

WORKDIR /app
# Node.js ëŸ°íƒ€ì„ì´ í¬í•¨ëœ ì´ë¯¸ì§€ì´ë¯€ë¡œ npmì´ ì¡´ì¬í•©ë‹ˆë‹¤.
COPY package.json package-lock.json* ./

# í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜ (ê°œë°œ ì˜ì¡´ì„± ì„¤ì¹˜ ë°©ì§€)
RUN npm install --production=false

# ëª¨ë“  ì†ŒìŠ¤ íŒŒì¼ ë³µì‚¬ (start.sh í¬í•¨)
COPY . .

# Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
RUN npm run build


# 2ë‹¨ê³„: NGINX ë° í”„ë¡œë•ì…˜ í™˜ê²½ (Runner Stage)
# NGINX ì´ë¯¸ì§€ë¥¼ ë² ì´ìŠ¤ë¡œ ì‚¬ìš©
FROM nginx:alpine AS runner

# í•„ìˆ˜: NGINX Alpine ì´ë¯¸ì§€ì— Node.js, npm, tini ì„¤ì¹˜
# tiniëŠ” í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ë¥¼ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
RUN apk add --no-cache nodejs npm tini

# NGINX ì„¤ì • íŒŒì¼ ë³µì‚¬
# Hostì˜ NGINX ì„¤ì •ì„ Docker ë‚´ë¶€ NGINXì— ì ìš©
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

# Next.js ì‹¤í–‰ í™˜ê²½ ë³µì‚¬
WORKDIR /usr/app/
# Next.js ë¹Œë“œ ê²°ê³¼ë¬¼ê³¼ ëŸ°íƒ€ì„ ì˜ì¡´ì„± ë³µì‚¬
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

# Next.jsì™€ NGINXë¥¼ ë™ì‹œì— ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë³µì‚¬
# ë¹Œë” ë‹¨ê³„ì˜ /app/start.shë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY start.sh /usr/bin/start.sh

# ğŸ’¡ í•µì‹¬ ìˆ˜ì • 1: ì¤„ë°”ê¿ˆ ë³€í™˜ì„ ë¨¼ì € ì‹œë„
RUN sed -i 's/\r$//' /usr/bin/start.sh

# ğŸ’¡ í•µì‹¬ ìˆ˜ì • 2: ì‹¤í–‰ ê¶Œí•œì„ ë…ë¦½ì ì¸ ëª…ë ¹ìœ¼ë¡œ ë¶€ì—¬
RUN chmod +x /usr/bin/start.sh

# ì»¨í…Œì´ë„ˆê°€ 80 í¬íŠ¸ë¥¼ ë…¸ì¶œí•©ë‹ˆë‹¤.
EXPOSE 80

# NGINXì™€ Node.jsë¥¼ í•¨ê»˜ ì‹œì‘í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ tinië¡œ ì‹¤í–‰
CMD ["tini", "--", "/usr/bin/start.sh"]